---
title: "Impact Report: Accelerator 2019-21"
subtitle: "Menstrual Health and Hygiene"
author:
- name: Taylor Conger
  affiliation: Duke university, Innovation and Enterprise
date: "`r format(Sys.time(), '%d %B %Y')`"
output: rmdformats::html_clean
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```





```{r load_libraries}
library(tidyverse)
library(plotly)
library(stringi)
library(scales)
library(stringr)
library(plotly)
library(textstem)
library(shiny)
library(lubridate)
library(rmdformats)

```


```{r import_data}
baseline_data <- read_csv("data/Cohort 1 M&E Analysis_Baseline_trimmed.csv", show_col_types = FALSE)
midline_data <- read_csv("data/Cohort 1 M&E Analysis_Midline_trimmed.csv", show_col_types = FALSE)
endline_data <- read_csv("data/Cohort 1 M&E Analysis_Endline_trimmed.csv", show_col_types = FALSE)
```

```{r data_clean}

baseline_data <- baseline_data %>% 
                  drop_na(OrgID) %>% 
     mutate(Organization = ifelse(str_detect(Organization, "SaCo"),"SaCoDé",Organization))

midline_data <- midline_data %>% 
                  drop_na(OrgID) %>% 
     mutate(Organization = ifelse(str_detect(Organization, "SaCo"),"SaCoDé",Organization))

endline_data <- endline_data %>% 
                  drop_na(OrgID) %>% 
                 mutate(Organization = ifelse(str_detect(Organization, "SaCo"),"SaCoDé",Organization))


```

```{r load_color_scheme, echo=FALSE}
#Page styling

#This is where you create your own custom color palette for the traces.
duke_colorway = c("#C84E00","#E89923","#FFD960","#A1B70D","#339898","#1D6363","#005587","#0577B1","#993399")

duke_colorway_75 = c(
  "rgba(200, 78, 0,.75)",
  "rgba(232, 153, 35,.75)",
  "rgba(255, 217, 96,.75)",
  "rgba(161, 183, 13,.75)",
  "rgba(51, 152, 152,.75)",
  "rgba(29, 99, 99,.75)",
  "rgba(0, 85, 135,.75)",
  "rgba(5, 119, 177,.75)",
  "rgba(153, 51, 153,.75)"
) 

duke_colorway_50 = c(
  "rgba(200, 78, 0,.5)",
  "rgba(232, 153, 35,.5)",
  "rgba(255, 217, 96,.5)",
  "rgba(161, 183, 13,.5)",
  "rgba(51, 152, 152,.5)",
  "rgba(29, 99, 99,.5)",
  "rgba(0, 85, 135,.5)",
  "rgba(5, 119, 177,.5)",
  "rgba(153, 51, 153,.5)"
) 
               
duke_colorway_25 = c(
  "rgba(200, 78, 0,.25)",
  "rgba(232, 153, 35,.25)",
  "rgba(255, 217, 96,.25)",
  "rgba(161, 183, 13,.25)",
  "rgba(51, 152, 152,.25)",
  "rgba(29, 99, 99,.25)",
  "rgba(0, 85, 135,.25)",
  "rgba(5, 119, 177,.25)",
  "rgba(153, 51, 153,.25)"
) 
               
duke_colorway_10 = c(
  "rgba(200, 78, 0,.1)",
  "rgba(232, 153, 35,.1)",
  "rgba(255, 217, 96,.1)",
  "rgba(161, 183, 13,.1)",
  "rgba(51, 152, 152,.1)",
  "rgba(29, 99, 99,.1)",
  "rgba(0, 85, 135,.1)",
  "rgba(5, 119, 177,.1)",
  "rgba(153, 51, 153,.1)"
) 
               

                
#This controls the background color for the entire chart. Probably best left white.
duke_paperbackground = c('rgba(255,255,255,0)')

#This controls the background for the plot. Probably best left white.
duke_plotcolor = c('rgba(255,255,255,.4)')

#Margin 

m <- list(l = 50, r = 50, b = 50, t = 50, pad = 4)

#Caption Style

fig_caption <- "font-family: 'Playfair Display','Helvetica Neue',Helvetica,Arial,sans-serif; font-weight: normal; font-size:110%"

plot_font <- list(
  family = "'Playfair Display','Helvetica Neue',Helvetica,Arial,sans-serif",
  size = 15,
  color = '#363636')

plot_font_small <- list(
  family = "'Playfair Display','Helvetica Neue',Helvetica,Arial,sans-serif",
  size = 12,
  color = '#363636')

plot_font_extra_small <- list(
  family = "'Playfair Display','Helvetica Neue',Helvetica,Arial,sans-serif",
  size = 10,
  color = '#363636')

```


## Introduction

The following data was compiled using three separate surveys: a) an intake survey administered at the beginning of the program; b) a midline survey; c) and an end-point survey. When these surveys were devised at the beginning of the program in 2019 they could not anticipate the vicissitudes that would be wrought by the COVID-19 pandemic. Consequently, later iterations of the survey probed different points of saliency. Additionally, questions were also revised as part of on iterative process to refine the survey more generally. On occasion, this has meant that questions are not always perfectly in alignment between different measuring points. All cases of such discrepancies have been noted.


## Target Demographics

Widely ranging in their approach, the six projects were also operating in different contexts. During the initial phases of the fellowship, the target demographics skewed overwhelmingly towards lower-income rural users. Over the course of the fellowship, the target demographic shifted more towards higher-income and urban beneficiaries. 

### Economic Target Group

The organizations were surveyed on their target population.  

```{r economic_demographics}
baseline_economic_demo <- baseline_data %>%
  drop_na(OrgID) %>%
  select(Survey:lower_income) %>%
  pivot_longer(high_income:lower_income,
               names_to = "income_level",
               values_to = "Percent") %>%
  group_by(Survey,income_level) %>%
  summarise(total = round(mean(as.numeric(Percent),0))) %>% 
  mutate(income_level = str_to_title(str_replace_all(income_level,"_"," ")))
```

### Economic Plot Baseline

```{r economic_demographics_plot}

plot_economic_demographics <- baseline_economic_demo %>% 
                              plot_ly(
                              labels = ~income_level, 
                              values = ~total, 
                              type = 'pie')

plot_economic_demographics <- plot_economic_demographics %>% 
  layout(title = "Economic Target Population: Baseline",
         colorway=duke_colorway,
         paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
     margin = m,
    font=plot_font
     )

plot_economic_demographics

```


### Economic Plot Midline

```{r midline_economic_demo}
midline_economic_demo <- midline_data %>%
  drop_na(OrgID) %>%
  mutate(across(high_income:lower_income, as.integer)) %>% 
  
         select(Survey:lower_income) %>%
  
  pivot_longer(high_income:lower_income,
               names_to = "income_level",
               values_to = "Percent") %>%
  group_by(Survey,income_level) %>%
   summarise(total = round(mean(as.numeric(Percent),0))) %>% 
  mutate(income_level = str_to_title(str_replace_all(income_level,"_"," ")))
```


```{r economic_demographics_plot_midline}

plot_economic_demographics_midline <- midline_economic_demo %>% 
                              plot_ly(
                              labels = ~income_level, values = ~total, type = 'pie')

plot_economic_demographics_midline <- plot_economic_demographics_midline %>% 
  layout(title = "Economic Target Population: Midline",
         colorway=duke_colorway,
         paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
     margin = m,
    font=plot_font
     )

plot_economic_demographics_midline

```

### Economic Plot Endline

```{r endline_demographic_demo}
endline_economic_demo <- endline_data %>%
  
  mutate(across(high_income:lower_income, as.integer)) %>% 
  
         select(Survey:lower_income) %>%
  
  pivot_longer(high_income:lower_income,
               names_to = "income_level",
               values_to = "Percent") %>%
  group_by(Survey,income_level) %>%
   summarise(total = round(mean(as.numeric(Percent),0))) %>% 
  mutate(income_level = str_to_title(str_replace_all(income_level,"_"," ")))



```



```{r plot_endline_demographic_demo}
plot_economic_demographics_endline <- endline_economic_demo %>% 
                              plot_ly(
                              labels = ~income_level, values = ~total, type = 'pie')

plot_economic_demographics_endline <- plot_economic_demographics_endline %>% 
  layout(title = "Economic Target Population: Endline",
         colorway=duke_colorway,
         paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
     margin = m,
    font=plot_font
     )

plot_economic_demographics_endline
```

### Observations

There is a shift away from lower income and towards middle and higher income. Part of this shift can be explained by a slight change in the phrase of the question. i.e. Poor and Very Poor, were not part of the initial survey. Expecting that this could also be explained by....


### Alternative visualization

This is another version of the same data that is more compact and shows the most important difference.

```{r}
all_demographic_economic <- baseline_economic_demo %>%
  bind_rows(midline_economic_demo) %>%
  bind_rows(endline_economic_demo) %>%
  mutate(income_level = str_to_lower(str_replace_all(income_level, " ", "_"))) %>%
  pivot_wider(names_from = income_level, values_from = total)

all_demographic_economic_plot <- all_demographic_economic %>%
  plot_ly(
    x = ~ Survey,
    y = ~ lower_income,
    type = "bar",
    name = "Lower Income"
  )
all_demographic_economic_plot <-  all_demographic_economic_plot %>%
  add_trace(y = ~ middle_income, name = "Middle Income") %>%
  add_trace(y = ~ high_income, name = "High Income")

all_demographic_economic_plot <-
  all_demographic_economic_plot %>% layout(
    xaxis = list(categoryorder = "trace"
                 ),
    yaxis = list(title = "Percent"), 
    barmode = "stack",
    title = "Economic Target Population",
         colorway=duke_colorway,
         paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
     margin = m,
    font=plot_font
     )

all_demographic_economic_plot
```




### Geographic Information

Target groups were also differentiated by location: Urban, suburban/periurban, and rural.

```{r geographic_information}
baseline_geographic_demo <- baseline_data %>%
                          select(Survey:Organization, urban:rural) %>% 
                            mutate(across(urban:rural,as.integer))

midline_geographic_demo <- midline_data %>% 
                            select(Survey:Organization, urban:rural) %>% 
                            mutate(across(urban:rural,as.integer))

endline_geographic_demo <- endline_data %>% 
                            select(Survey:Organization, urban:rural) %>% 
                             mutate(across(urban:rural,as.integer))

all_geographic_demo <- baseline_geographic_demo %>% 
                      bind_rows(midline_geographic_demo) %>% 
                      bind_rows(endline_geographic_demo)

all_geographic_demo_table <- all_geographic_demo %>% 
                        group_by(Survey) %>% 
                        summarise(urban = mean(urban), suburban_periurban = mean(suburban_periurban), rural = mean(rural))

```


```{r plot_geographic}

all_geographic_demo_plot <- all_geographic_demo_table %>%
  plot_ly(
    x = ~ Survey,
    y = ~ rural,
    type = "bar",
    name = "Rural"
  )
all_geographic_demo_plot <-  all_geographic_demo_plot %>%
  add_trace(y = ~ suburban_periurban, name = "Suburban/Peri-Urban") %>%
  add_trace(y = ~ urban, name = "Urban")

all_geographic_demo_plot <-
all_geographic_demo_plot %>% layout(
    xaxis = list(categoryorder = "array",
                 categoryarray = c("baseline", "midline", "endline")),
    yaxis = list(title = "Percent"), 
    barmode = "stack",
  title = "Geographic Target Population",
         colorway=duke_colorway,
         paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
     margin = m,
    font=plot_font
     )

all_geographic_demo_plot

```

### Geographic trends

The focus becomes more urban over time.


## Human Resources Trends

Organizations provided information on their hiring practices over the course of the fellowship. Particular attention was paid to gender distribution.

```{r gender}

baseline_hr_gender <- baseline_data %>%
  select(Survey:Organization, full_time_total:part_time_female) %>%
  mutate(across(full_time_total:part_time_female, as.integer))

midline_hr_gender <- midline_data %>%
  select(Survey:Organization, full_time_total:part_time_female) %>%
  mutate(across(full_time_total:part_time_female, as.integer))

endline_hr_gender <- endline_data %>%
  select(Survey:Organization, full_time_total:part_time_female) %>%
  mutate(across(full_time_total:part_time_female, as.integer))

```

```{r gender_percent}

full_hr_gender <- baseline_hr_gender %>%
  left_join(midline_hr_gender,
            by = "OrgID",
            suffix = c("_baseline", "_midline")) %>%
  left_join(endline_hr_gender,
            by = "OrgID",
            suffix = c("_baseline", "_endline")) %>%
  select(!(Organization_midline)) %>%
  select(!(Organization)) 
  

prct_changes_ft_all <- full_hr_gender %>%
  mutate(
    baseline = 0,
    midline = (full_time_total_midline -
                  full_time_total_baseline) / full_time_total_baseline,
    
    endline = (full_time_total - full_time_total_midline)/ full_time_total_midline) %>% 
  select(!(full_time_total_baseline:part_time_female)) %>% 
  select(!(1)) %>% 
  mutate(across(everything(), ~replace_na(.,0))) %>% 
  bind_rows(summarise(., OrgID = 0,
                      across(baseline:endline, mean),
                      across(where(is.character), ~"Mean"))) %>% 
  pivot_longer(baseline:endline, names_to = "survey", values_to = "full_time_total")  
  
prct_changes_ft_f <- full_hr_gender %>%
  mutate(
    baseline = 0,
    midline = (full_time_female_midline -
                  full_time_female_baseline) / full_time_female_baseline,
    
    endline = (full_time_female - full_time_female_midline)/ full_time_female_midline) %>% 
  select(!(full_time_total_baseline:part_time_female)) %>% 
  select(!(1)) %>% 
  mutate(across(everything(), ~replace_na(.,0))) %>% 
  bind_rows(summarise(., OrgID = 0,
                      across(baseline:endline, mean),
                      across(where(is.character), ~"Mean"))) %>% 
  pivot_longer(baseline:endline, names_to = "survey", values_to = "full_time_female") 

prct_changes_pt_all <- full_hr_gender %>%
  mutate(baseline =0,
    midline = ifelse(
      part_time_total_baseline != 0, (part_time_total_midline -
         part_time_total_baseline) / part_time_total_baseline,0),
    
    endline = ifelse(
      part_time_total_baseline != 0,
      (part_time_total -
         part_time_total_midline)
      / part_time_total_midline,
      0
    )
  )%>% 
  select(!(full_time_total_baseline:part_time_female)) %>% 
  select(!(1)) %>% 
  mutate(across(everything(), ~replace_na(.,0))) %>% 
  bind_rows(summarise(., OrgID = 0,
                      across(baseline:endline, mean),
                      across(where(is.character), ~"Mean"))) %>% 
  pivot_longer(baseline:endline, names_to = "survey", values_to = "part_time_total") 

prct_changes_pt_female <- full_hr_gender %>%
  mutate(baseline = 0,
    midline = ifelse(
      part_time_female_baseline != 0,
      (part_time_female_midline -
         part_time_female_baseline) / part_time_female_baseline,
      0
    ),
    
    endline = ifelse(
      part_time_female_midline != 0,
      (part_time_female -
         part_time_female_midline)
      / part_time_female_midline,
      0
    )
  )%>% 
  select(!(full_time_total_baseline:part_time_female)) %>% 
  select(!(1)) %>% 
  mutate(across(everything(), ~replace_na(.,0))) %>% 
  bind_rows(summarise(., OrgID = 0,
                      across(baseline:endline, mean),
                      across(where(is.character), ~"Mean"))) %>% 
  pivot_longer(baseline:endline, names_to = "survey", values_to = "part_time_female") 


```

```{r recombine_data}

all_percent_change <- prct_changes_ft_all %>% 
                      left_join(prct_changes_ft_f, by = c("OrgID"="OrgID", "Organization_baseline" = "Organization_baseline", "survey" = "survey")) %>% 
                      left_join(prct_changes_pt_all, by = c("OrgID"="OrgID", "Organization_baseline" = "Organization_baseline", "survey" = "survey")) %>% 
                      left_join(prct_changes_pt_female, by = c("OrgID"="OrgID", "Organization_baseline" = "Organization_baseline", "survey" = "survey")) %>% 
                      rename(Organization = Organization_baseline) %>% 
                      pivot_wider(Organization:survey, names_from = Organization, values_from = full_time_total:part_time_female) %>% 
                      add_column(dummy_total = 0) %>% 
                      add_column(dummy_women = 0) %>% 
                      add_column(date= c("2020-11-01","2021-05-01","2021-12-01")) %>% 
                      mutate(date = as_date(date))

```

```{r plot_full_time_all}

plot_full_time_all <- all_percent_change %>%
  plot_ly(
    x = ~ date,
    y = ~ `full_time_total_Lily Health`,
    type = 'scatter',
    mode = 'lines',
    name = "Lily Health",
    line = list(color = duke_colorway [1],width = 1),
    opacity = .4,
     legendrank = 6
  ) %>%
  add_trace(
    y =  ~ `full_time_female_Lily Health`,
    name = "Lily Health (Women)",
    line = list(color = duke_colorway[1], dash = "dash"),
    showlegend = FALSE

  ) %>%
  add_trace(
    y =  ~ `full_time_total_Kasole Secrets Company Ltd`,
    name = "Kasole Secrets Company",
    line = list (color = duke_colorway[2]),
     legendrank = 5
    
  ) %>%
  add_trace(
    y =  ~ `full_time_female_Kasole Secrets Company Ltd`,
    name = "Kasole Secrets Company (Women)",
    line = list (color = duke_colorway[2], dash = 'dash'),
    showlegend = FALSE
  ) %>%                     
  add_trace(
    y =  ~ `full_time_total_Femme International`,
    name = "Femme International",
    line = list (color = duke_colorway[3]),
     legendrank = 4
    
  ) %>% 
add_trace(
    y =  ~ `full_time_female_Femme International`,
    name = "Femme International (Women)",
    line = list (color = duke_colorway[3], dash = "dash"),
    showlegend = FALSE
    
  ) %>% 

  add_trace(
    y =  ~ `full_time_total_SaCoDé`,
    name = "SaCoDé",
    line = list (color = duke_colorway[4]),
     legendrank = 8
  ) %>%
  add_trace(
    y =  ~ `full_time_female_SaCoDé`,
    name = "SaCoDe (Women)",
    line = list (color = duke_colorway[4], dash = "dash"),
    showlegend = FALSE
  ) %>%
  add_trace(
    y =  ~ `full_time_total_Tai Tanzania`,
    name = "Tai Tanzania",
    line = list (color = duke_colorway[5]),
     legendrank = 9
    
  ) %>%
  add_trace(
    y =  ~ `full_time_total_Tai Tanzania`,
    name = "Tai Tanzania (Women)",
    line = list (color = duke_colorway[5], dash = "dash"),
    showlegend = FALSE
    
  ) %>%
  add_trace(
    y =  ~ `full_time_total_LVCT HEALTH`,
    name = "LVCT Health",
    line = list (color = duke_colorway[6]),
     legendrank = 7
  ) %>%
  add_trace(
    y =  ~ `full_time_female_LVCT HEALTH`,
    name = "LVCT Health (Women)",
    line = list (color = duke_colorway[6], dash = "dash"),
    showlegend = FALSE
  ) %>%
  add_trace(
    y =  ~ `full_time_total_Mean`,
    name = "Mean",
    line = list (color = duke_colorway[7], width = 2),
    legendrank = 3,
    opacity = 1
  ) %>%
  add_trace(
    y =  ~ `full_time_female_Mean`,
    name = "Mean (Women)",
    line = list (
      color = duke_colorway[7],
      width = 2,
      dash = "dash"),
      showlegend= FALSE,
    opacity = 1
    
    
  ) %>%
  add_trace(
    y = ~ dummy_total,
    name = "All Full-Time",
    line = list(color = "rgb(0,0,0)"),
    #visible = "legendonly",
    showlegend = TRUE,
    legendrank = 1
   
  ) %>%
  add_trace(
    y = ~ dummy_women,
    name = "Full-Time Women",
    line = list(color = "#000000", dash = "dash"),
    legendrank = 2
    
    )

plot_full_time_all <- plot_full_time_all %>%
  layout(
    xaxis = list(
     # categoryorder = "array",
    type = "date",
    tickmode = "array",
    tickvals = c("2020-11-01","2021-05-01","2021-12-01"),
    tickformat = "%Y-%b",
    #rangebreaks = list(values = c("2020-11-01","2021-05-01","2021-12-01")),
      showgrid = FALSE
    ),
    yaxis = list(title = "Percent Change", showgrid = FALSE, tickformat = ".0%"),
    title = "Full Time Employment Change",
    
    paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
    margin = m,
    font = plot_font
  )

plot_full_time_all
```

In general, the employment data shows a downward trend. On average organizations reduced their workforce by `r round(all_percent_change$full_time_total_Mean[3]*100,0)`%, with the female workforce reducing by an equal amount `r round(all_percent_change$full_time_female_Mean[3]*100,0)`%. 

## Revenue
They made money

```{r revenue_table}
revenue <- endline_data %>% 
            select (c(2:3, revenue_2019:revenue_2021)) %>% 
            mutate(across(revenue_2019:revenue_2021, as.numeric)) %>% 
            mutate(Mean = rowMeans(across(revenue_2019:revenue_2021),na.rm = TRUE))  %>% 
            arrange(Organization) %>% 
            mutate(OrgOrder = row_number())

            #pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
            #mutate(Year = str_remove_all(Year, "revenue_")) %>% 
            #pivot_wider(Year,names_from = Organization, values_from = Revenue)
```


```{r individual_revenue_tables}
#Generate individual tables

revenue_1 <- revenue %>% 
             filter(OrgOrder ==1) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_")) 

revenue_2 <- revenue %>% 
             filter(OrgOrder ==2) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_")) 

revenue_3 <- revenue %>% 
             filter(OrgOrder ==3) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_"))

revenue_4 <- revenue %>% 
             filter(OrgOrder ==4) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_")) 

revenue_5 <- revenue %>% 
             filter(OrgOrder ==5) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_")) 

revenue_6 <- revenue %>% 
             filter(OrgOrder ==6) %>% 
             pivot_longer(revenue_2019:Mean, names_to = "Year", values_to = "Revenue") %>% 
             mutate(Year = str_remove_all(Year, "revenue_")) 
```

```{r revenue_plot}

plot_revenue_1 <- revenue_1 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                )  %>% 
  layout(yaxis = list(tickprefix = "$"))
                

plot_revenue_2 <- revenue_2 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                ) %>% 
  layout(yaxis = list(tickprefix = "$"))
               

plot_revenue_3 <- revenue_3 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                ) %>% 
  layout(yaxis = list(tickprefix = "$"))
              

plot_revenue_4 <- revenue_4 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                ) %>% 
  layout(yaxis = list(tickprefix = "$"))
               

plot_revenue_5 <- revenue_5 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                ) %>% 
  layout(yaxis = list(tickprefix = "$"))
               
plot_revenue_6 <- revenue_6 %>% 
                plot_ly(
                  x = ~Year,
                  y = ~Revenue,
                  type = "bar",
                  marker = list(color = duke_colorway[1:4])
                ) %>% 
  layout(yaxis = list(tickprefix = "$"))
                

plot_revenues <- subplot(plot_revenue_1, plot_revenue_2, plot_revenue_3,plot_revenue_4,plot_revenue_5,plot_revenue_6, nrows = 3, shareX = TRUE, margin=.05) %>% 
  layout(title = list(text = "Yearly Revenue by Organization"),
                  yaxis = list(tickprefix = "$"),
                  paper_bgcolor = duke_paperbackground,
                  plot_bgcolor = duke_plotcolor,
                  margin =list(t=50),
                  font = list(
  family = "'Playfair Display','Helvetica Neue',Helvetica,Arial,sans-serif",
  size = 12,
  color = '#363636'),
                           showlegend=FALSE
                  )


annotations = list( 
  list( 
    x = 0.2,  
    y = 1.0,  
    text = revenue_1$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.8,  
    y = 1,  
    text = revenue_2$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.2,  
    y = 0.625,  
    text = revenue_3$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.625,  
    text = revenue_4$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.825,  
    y = 0.45,  
    text = "2021 data<br>pending",  
    xref = "paper",  
    yref = "paper",  
    align = "left",
    
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.2,  
    y = 0.3,  
    text = revenue_5$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.3,  
    text = revenue_6$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  )
  
  )

plot_revenues <- plot_revenues %>% layout(annotations=annotations)


plot_revenues







```

## Revenue Streams



```{r revenue_streams}

lvct_revenue <-  midline_data %>% 
                 select(c(1:3, payment_from_sales_ly:fundraising_3y)) %>% 
                      filter(OrgID == 6) %>% 
                  mutate(across(payment_from_sales_ly:fundraising_3y, as.double)) %>% 
                  mutate(Survey = "baseline")
                      

baseline_revenue  <-  baseline_data %>%  
                      select(c(1:3,payment_from_sales_ly:fundraising_3y)) %>% 
                      filter(OrgID != 6) %>% 
                        mutate(across(payment_from_sales_ly:fundraising_3y, as.double)) %>% 
                      bind_rows(lvct_revenue) %>% 
                      rename_with(~ gsub("ly", "initial", .x, fixed = TRUE)) %>% 
                      rename_with(~ gsub("3y", "projected", .x, fixed = TRUE)) 


endline_revenue <-  endline_data %>% 
                        select(c(1:3,payment_from_sales_ly:fundraising_3y)) %>% 
                      mutate(across(payment_from_sales_ly:fundraising_3y, as.double)) %>% 
                      select(!ends_with("3y")) %>% 
                      rename_with(~ gsub("ly", "current", .x, fixed = TRUE))  

total_revenue <- baseline_revenue %>% 
                  left_join(endline_revenue, by = c("OrgID"="OrgID")) %>% 
                  select(!ends_with(".y")) %>% 
                  rename_with(~ gsub(".x", "", .x, fixed = TRUE)) %>% 
                  pivot_longer(payment_from_sales_initial:fundraising_current, names_to = "category", values_to = "values")  %>% 
                  arrange(Organization,category) %>% 
                  mutate(date = str_remove_all(category,".*(?=\\_)_" )) %>% 
                  mutate(category = gsub("_[^_]*$", "", category)) %>% 
                  pivot_wider(c("Organization","OrgID","date"), names_from = category, values_from = values) %>% 
  group_by(date) %>% 
  mutate(OrgOrder = row_number())
```


```{r individual_plots}


projections_1 <-  total_revenue %>%
  filter(OrgOrder == 1) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO"))

plot_projections_1 <- projections_1 %>%
  plot_ly(
    x = ~ initial,
    y = ~ name,
    type = "bar",
    name = "Initial",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/")
    )
  ) %>%
  add_trace(
    x =  ~ current,
    name = "Current",
    marker = list(
      color = duke_colorway_10[2],
      line = list(color = duke_colorway_75[2], width = 1.5),
      pattern = list(shape = "\\")
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected",
    marker = list(
      color = "transparent",
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "/")
    )
    
  ) %>%
  layout(
    barmode = "overlay",
    xaxis = list(title = "Percent", ticksuffix = "%"),
    yaxis = list(title = "Funding Type", categoryorder = "category descending"),
    paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
    margin = list(t = 50),
    font = plot_font_small
  )
#plot_projections_1
```



```{r projections_2}


projections_2 <-  total_revenue %>%
  filter(OrgOrder == 2) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_sentence(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO"))

plot_projections_2 <- projections_2 %>%
  plot_ly(
    x = ~ initial,
    y = ~ name,
    type = "bar",
    name = "Initial",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/")
    )
  ) %>%
  add_trace(
    x =  ~ current,
    name = "Current",
    marker = list(
      color = duke_colorway_10[2],
      line = list(color = duke_colorway_75[2], width = 1.5),
      pattern = list(shape = "\\")
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected",
    marker = list(
      color = "transparent",
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "/")
    )
    
  ) %>%
  layout(
    barmode = "overlay",
    xaxis = list(title = "Percent", ticksuffix = "%"),
    yaxis = list(title = "Funding Type", categoryorder = "category descending"),
    paper_bgcolor = duke_paperbackground,
    plot_bgcolor = duke_plotcolor,
    margin = list(t = 50),
    font = plot_font_small
  )
#plot_projections_2

```


```{r total_revenue_reduced}
total_revenue_reduced <- total_revenue %>%
  mutate(sales = across(starts_with(c("payment_", "third"))) %>% rowSums(.)) %>%                          select(!(starts_with(c("payment_","third"))))
```


```{r individual_revenue_reduced}
projection_reduced_1 <- total_revenue_reduced %>%
  filter(OrgOrder == 1) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))

projection_reduced_2 <- total_revenue_reduced %>%
  filter(OrgOrder == 2) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))

projection_reduced_3 <- total_revenue_reduced %>%
  filter(OrgOrder == 3) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))

projection_reduced_4 <- total_revenue_reduced %>%
  filter(OrgOrder == 4) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))

projection_reduced_5 <- total_revenue_reduced %>%
  filter(OrgOrder == 5) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))

projection_reduced_6 <- total_revenue_reduced %>%
  filter(OrgOrder == 6) %>%
  select(!(OrgOrder)) %>%
  select_if(negate(function(col)
    is.numeric(col) && sum(col) < 1)) %>%
  pivot_longer(4:last_col()) %>%
  pivot_wider(c("Organization", "name"),
              names_from = date,
              values_from = value) %>%
  mutate(name = str_to_title(str_replace_all(name, "_", " "))) %>%
  mutate(name = str_replace(name, "Ngo", "NGO/")) %>%
  mutate(name = str_replace(name, "Csr", "/CSR"))


```


```{r funding_plots}
plot_projections_reduced_1 <- projection_reduced_1 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend= TRUE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend = TRUE
    )
) %>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
           showlegend = TRUE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 



plot_projections_reduced_2 <- projection_reduced_2 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend=FALSE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend=FALSE
  )
)%>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
             showlegend = FALSE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 
 




plot_projections_reduced_3 <- projection_reduced_3 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend=FALSE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend=FALSE
    )
    
  ) %>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
             showlegend = FALSE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 


plot_projections_reduced_4 <- projection_reduced_4 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend=FALSE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend=FALSE
    )
 )%>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
             showlegend = FALSE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 

  

plot_projections_reduced_5 <- projection_reduced_5 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend=TRUE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend=TRUE
    )
  ) %>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
             showlegend = TRUE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 


plot_projections_reduced_6 <- projection_reduced_6 %>%
  plot_ly(
    x = ~ current,
    y = ~ name,
    type = "bar",
    name = "Current",
    orientation = "h",
    marker = list(
      color = duke_colorway_10[1],
      line = list(color = duke_colorway_75[1], width = 1.5),
      pattern = list(shape = "/"),
      showlegend=FALSE
    )
  ) %>%
  add_trace(
    x =  ~ projected,
    name = "Projected in baseline",
    marker = list(
      color = duke_colorway_10[8],
      line = list(color = duke_colorway_75[8], width = 1.5),
      pattern = list(shape = "\\"),
      showlegend=FALSE
    )
) %>% layout(barmode = "overlay",
             xaxis = list(title = "Percent", ticksuffix = "%"),
             yaxis = list(title = "Funding Type", categoryorder = "category descending"),
             paper_bgcolor = duke_paperbackground,
            # showlegend = FALSE,
             plot_bgcolor = duke_plotcolor,
             margin =list(t=50),
             font = plot_font_extra_small
             ) 



```

```{r funding_subplot}

plot_projections <- subplot(plot_projections_reduced_1, plot_projections_reduced_2, plot_projections_reduced_3,plot_projections_reduced_4,plot_projections_reduced_5,plot_projections_reduced_6, nrows = 3, shareX = TRUE, margin=.09) %>% 
  layout(title = list(text = "Projected versus Current Funding Sources"),
         barmode = "overlay",
    xaxis = list(title = "Percent", ticksuffix = "%"),
 #  yaxis = list(title = "Funding Type", categoryorder = "category descending"),
                  paper_bgcolor = duke_paperbackground,
                  plot_bgcolor = duke_plotcolor,
                  margin =list(t=50),
                  font = plot_font_extra_small
                 )


annotations = list( 
  list( 
    x = 0.2,  
    y = 1.0,  
    text = projection_reduced_1$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.8,  
    y = 1,  
    text = projection_reduced_2$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.2,  
    y = 0.625,  
    text = projection_reduced_3$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.625,  
    text = projection_reduced_4$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  
  list( 
    x = 0.2,  
    y = 0.3,  
    text = projection_reduced_5$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.3,  
    text = projection_reduced_6$Organization[1],  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  )
)

plot_projections <- plot_projections %>% layout(annotations=annotations)

plot_projections
```


```{r likert_scale}

baseline_likert <- baseline_data %>% 
                    select(c(1,pitch_investors:apply_fellowships)) %>% 
                   group_by(Survey) %>% 
                    drop_na() %>% 
                mutate(across(pitch_investors:apply_fellowships,as.integer)) %>% 
                    summarise(across(where(is.numeric), mean))

endline_likert <- endline_data %>% 
                   arrange(Organization) %>% 
                   mutate(OrgOrder = row_number()) %>% 
                   relocate(OrgOrder, .before =1) %>% 
                    select(c(2,pitch_investors:apply_fellowships)) %>% 
                   group_by(Survey) %>% 
                    mutate(across(pitch_investors:apply_fellowships,as.integer)) %>% 
                  summarise(across(where(is.numeric), mean))
likert_total <- baseline_likert %>% 
                bind_rows(endline_likert) %>% 
                pivot_longer(where(is.numeric), names_to = "question") %>% 
                group_by(question) %>% 
                arrange(question, Survey)
               # pivot_wider (question, names_from = "Survey", values_from = "value")

```


```{r}
likert_ends <- likert_total %>% 
                filter (Survey == "endline")

plot_likert <- likert_total %>% 
                plot_ly(
                  x = ~value,
                  y = ~question,
                  name = ~question,
                  type = "scatter",
                  mode = "line",
                  line = list(color = duke_colorway_10[1],width = 14),
                  orientation = "h"  
                  
                ) 

plot_likert <- plot_likert %>% 
                add_trace(likert_ends, x = ~likert_ends$value,
                  y = ~likert_ends$question,
                  name = ~likert_ends$question,
                  type = "scatter",
                  mode = "markers",
                  marker = list(size
                                = 10, symbol = "arrow-right"),
                  orientation = "h",  
                  color = duke_colorway_75[1]
                  )

plot_likert <- plot_likert %>%   
                  layout(
                    xaxis = list(tickvals = c(1,2,3,4,5,6,7),
                                 ticktext = c("1<br>Not at all confident", "2", "3", "4", "5","6", "7<br>extremely confident"),
                                 range = c(1,7)),
                    showlegend = FALSE
                    )
                
plot_likert

```


```{r unique_users}

baseline_likert_mode <- baseline_data %>% 
                    select(c(1:3,pitch_investors:apply_fellowships)) %>% 
                   group_by(Survey) %>% 
                    drop_na() %>% 
                    pivot_longer(pitch_investors:apply_fellowships) %>% 
                    #pivot_wider(names_from = value) %>% 
                    group_by(Survey,name, value) %>% 
                    count %>% 
                    pivot_wider(Survey:name, names_from = value, values_from = n, values_fill = 0)  %>% 
              mutate ("1"=0, "5" = 0) %>% 
                    relocate("3",.after = name) %>% 
                    relocate("2",.after = name) %>% 
                    relocate("1",.after = name) %>% 
                    relocate("5", .after = "4")
                 

endline_likert_mode <- endline_data %>% 
                      filter(OrgID !=6) %>% 
                   select(c(1:3,pitch_investors:apply_fellowships)) %>% 
                   group_by(Survey) %>% 
                    drop_na() %>% 
                    pivot_longer(pitch_investors:apply_fellowships) %>% 
                    #pivot_wider(names_from = value) %>% 
                    group_by(Survey,name, value) %>% 
                    count %>% 
                    pivot_wider(Survey:name, names_from = value, values_from = n, values_fill = 0)   %>% 
                    mutate ("1" = 0, "2"=0, "3"= 0) %>% 
                    relocate(7:9, .after= "name") %>% 
                    relocate("4", .after = "3")
                  
  

all_likert_mode <- baseline_likert_mode %>% 
                   bind_rows(endline_likert_mode) %>% 
                   arrange(name)
             

all_likert_mode

```

